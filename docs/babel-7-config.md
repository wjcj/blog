Babel 7.x é…ç½®ä¸ä½¿ç”¨
=====

æœ¬æ–‡ä¸»è¦ä»‹ç» Babel 7 çš„åŸºæœ¬ä½¿ç”¨æ–¹å¼ä¸å…¶æ–°ç‰¹æ€§åœ¨ monorepos ç±»å‹é¡¹ç›®ä¸­é…ç½®åº”ç”¨ã€‚å¯ä»¥ä»[è¿™é‡Œ](https://github.com/wjcj/babel-7-monorepo-demo) `clone` ç¤ºä¾‹æºç ï¼Œç®€å•çš„ç¤ºä¾‹ä¹Ÿå¯ä»¥ä½¿ç”¨ Babel æä¾›çš„[åœ¨çº¿ç¼–è¯‘å¹³å°](https://babeljs.io/repl/)ã€‚

## å¼€å§‹

Babel æ˜¯ä¸€ä¸ª JavaScript ç¼–è¯‘å™¨ã€‚ä¸»è¦ç”¨äºå°† ECMAScript 2015+ ä»£ç è½¬æ¢æˆèƒ½å¤Ÿè¿è¡Œåœ¨å½“å‰æˆ–æ—§ç‰ˆæœ¬çš„æµè§ˆå™¨æˆ–å…¶ä»–ç¯å¢ƒä¸­çš„è¯­æ³•ã€‚

> è¯­æ³•è½¬æ¢ï¼›é€šè¿‡ Polyfill æ–¹å¼åœ¨ç›®æ ‡ç¯å¢ƒä¸­æ·»åŠ ç¼ºå¤±çš„ç‰¹æ€§ï¼ˆé€šè¿‡ç¬¬ä¸‰æ–¹ polyfill æ¨¡å—ï¼Œä¾‹å¦‚ core-jsï¼Œå®ç°ï¼‰ï¼›æºç è½¬æ¢ (codemods)ã€‚

å®˜ç½‘ä¸­æåˆ° Babel ä¼šä¸ºä½ åšçš„å‡ ä»¶äº‹ğŸ‘†ï¼Œè¿™æ˜¯å› ä¸º ECMAScript 2015+ ä»£ç ä¸­é™¤äº†åŒ…å«æ–°çš„è¯­æ³•ï¼Œè¿˜åŒ…å«ä¸€äº›æ–°çš„ç‰¹æ€§ï¼šå†…ç½®å¯¹è±¡ï¼ˆå¦‚ `Promise`ï¼‰ã€å†…ç½®å¯¹è±¡æ–°å¢é™æ€å±æ€§ï¼ˆå¦‚ `Array.from`ï¼‰å’Œå®ä¾‹å±æ€§ï¼ˆå¦‚ `[].includes`ï¼‰ã€‚è¯­æ³•å¯ä»¥é€šè¿‡æ’ä»¶è½¬æ¢ä¸º ES5 è¯­æ³•å®ç°æ—§ç‰ˆæµè§ˆå™¨å…¼å®¹ï¼Œè€Œæ–°å¢ç‰¹æ€§åˆ™é€šè¿‡æ³¨å…¥ polyfill å®ç°ï¼Œpolyfill æ–°å¢ç‰¹æ€§åˆ°å…¨å±€ç¯å¢ƒï¼ˆ`global scope`ï¼‰ã€åŸç”Ÿå¯¹è±¡ï¼ˆå¦‚ `Array`ï¼‰æˆ–å…¶åŸå‹ï¼ˆå¦‚ `Array.prototype`ï¼‰ä¸Šï¼Œä»è€Œä¹Ÿä¼šå¯¼è‡´å…¨å±€ç¯å¢ƒæ±¡æŸ“ã€‚Babel ä½¿ç”¨ `core-js` æ¥æä¾›çš„ polyfillã€‚

**`@babel/polyfill` å¼€å§‹å·²åºŸå¼ƒï¼ŒBabel 7.4.0 ç‰ˆæœ¬å¼€å§‹ä¸æ¨èä½¿ç”¨**

`@babel/polyfill` æ˜¯ Babel æä¾› polyfill ç‹¬ç«‹å‡ºæ¥çš„ä¸€ä¸ªåº“ã€‚å…¶åŒ…å« `core-js` å’Œä¸€ä¸ªè‡ªå®šä¹‰çš„ `regenerator runtime` æ¥æ¨¡æ‹Ÿå®Œæ•´çš„ ES2015+ ç¯å¢ƒï¼Œä»¥å‰è¿™ä¸ªåº“æœ¬èº«ç­‰ä»·äºï¼š

``` js
import "core-js/shim";  // åŒ…å« < Stage 4 çš„é˜¶æ®µææ¡ˆ
import "regenerator-runtime/runtime"; // ç”Ÿæˆå™¨å‡½æ•°ï¼ˆgenerator functionsï¼‰
```

ä½¿ç”¨ `@babel/polyfill` æ—¶ä¼šæ³¨å…¥å…¨éƒ¨çš„ polyfillï¼Œè¿™å¯¹äºä¸€ä¸ªåº“/å·¥å…·æ¥è¯´å¤ªå¤šäº†ï¼Œæˆ–è€…ä½ æ— æ³•å®Œå…¨æ§åˆ¶ä»£ç çš„è¿è¡Œçš„ç¯å¢ƒï¼Œæ±¡æŸ“å…¨å±€å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚æ‰€ä»¥å®ƒä»…é€‚ç”¨äºåº”ç”¨ç¨‹åºæˆ–å‘½ä»¤è¡Œå·¥å…·ã€‚ç°åœ¨çš„ `@babel/polyfill` æœ¬èº«ä½¿ç”¨ `core-js v2` ä¸­æ ‡å‡† ECMAScript ç‰¹æ€§çš„ polyfillï¼Œå³ï¼š

``` js
import "core-js/stable"; // Stage 4 çš„é˜¶æ®µææ¡ˆ
import "regenerator-runtime/runtime";
```

å¦‚æœä½ éœ€è¦å¡«å……å¤„äºææ¡ˆé˜¶æ®µï¼ˆ< Stage 4ï¼‰çš„ç‰¹æ€§ï¼Œéœ€è¦å®‰è£… `core-js v2+` å¹¶ä»å…¶ä¸­å¯¼å…¥å¯¹åº”çš„ polyfillï¼Œæ¯”å¦‚ï¼š

``` js
// for core-js v2:
import "core-js/fn/array/flat-map";
// for core-js v3:
import "core-js/features/array/flat-map";
```
è€Œ `core-js v3` ä¹Ÿå·²ç»å®Œå…¨æ¨¡å—åŒ–ï¼Œç›´æ¥ä½¿ç”¨ `core-js` å¯ä»¥æ ¹æ®éœ€è¦å•ç‹¬å¼•å…¥æŸä¸ª polyfillï¼Œé…åˆ `@babel/preset-env` å¯ä»¥æ ¹æ®ç›®æ ‡ç¯å¢ƒæ™ºèƒ½çš„å¼•å…¥éœ€è¦çš„ polyfillã€‚æ‰€ä»¥ `@babel/polyfill` çš„ä»·å€¼å·²ç»ä¸å¤§äº†ã€‚

## å¸¸ç”¨å‘½ä»¤

```
npm install @babel/cli @babel/core --save-dev
```

- `@babel/cli`ï¼šå†…ç½®çš„ CLI å‘½ä»¤è¡Œå·¥å…·ï¼Œå¯é€šè¿‡å‘½ä»¤è¡Œç¼–è¯‘æ–‡ä»¶ã€‚
- `@babel/core`ï¼šBabel æ ¸å¿ƒåŠŸèƒ½æ¨¡å—ã€‚åŒ…å«äº†è§£æã€è½¬æ¢ã€ç”Ÿæˆç›¸å…³ [API](https://babeljs.io/docs/en/babel-core#transformsync)ã€‚

å¸¸ç”¨å‘½ä»¤ï¼š
``` bash
npx babel example.js
# æŒ‡å®šè¾“å‡ºæ–‡ä»¶å’Œå¯åŠ¨ç›‘å¬æ¨¡å¼
npx babel example.js --out-file compiled.js --watch
# ç®€å†™
npx babel example.js -o compiled.js -w

# ç¼–è¯‘ç›®å½•
npx babel src --out-dir lib
# ç®€å†™
npx babel src -d lib
```
æ›´å¤š `babel` å‘½ä»¤æŸ¥çœ‹[è¿™é‡Œ](https://www.babeljs.cn/docs/babel-cli)ã€‚

*æ‰§è¡Œ npx babel ä¹‹å‰é¦–å…ˆè¦å®‰è£… `@babel/cli` å’Œ `@babel/core`ï¼Œå¦åˆ™ npx å°†å®‰è£…è€æ—§çš„ `babel 6.x` ç‰ˆæœ¬ã€‚*

å¦‚æœä¸æƒ³æ¯æ¬¡éƒ½éœ€è¦è¾“å…¥ `npx` å’Œå¦‚æ­¤é•¿çš„æŒ‡ä»¤ï¼Œå¯ä»¥å°†å‘½ä»¤å†™å…¥ npm è¿è¡Œè„šæœ¬ï¼Œ`npm run build` ç¼–è¯‘ `src` ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶ï¼š

``` json_
{
  "scripts": {
    "build": "babel src --out-dir lib --watch"
  }
}
```
åŒºåˆ«äº webpackã€rollup çš„ç¼–è¯‘æ–¹å¼ï¼ŒBabel æ˜¯æ–‡ä»¶åˆ°æ–‡ä»¶çš„ç¼–è¯‘ï¼Œä¸éœ€è¦æŒ‡å®šä»æŸä¸ªå…¥å£æ–‡ä»¶å¼€å§‹ã€‚

## é…ç½®æ–‡ä»¶

æ‰§è¡Œä¸Šé¢çš„ `babel` å‘½ä»¤ï¼Œä½ ä¼šå‘ç”Ÿå®ƒä»€ä¹ˆéƒ½ä¸ä¼šåšï¼Œåªæ˜¯å°†ä»£ç æ‹·è´åˆ°å¦ä¸€å¤„ã€‚åªæœ‰ä¸º Babel æŒ‡å®šäº†æ’ä»¶ï¼ˆpluginsï¼‰æˆ–é¢„è®¾ï¼ˆpresetsï¼Œä¸€ç»„æ’ä»¶ï¼‰ï¼ŒBabel æ‰ä¼šå¯¹ä»£ç è¿›è¡Œè½¬æ¢ã€‚

é€šå¸¸é€šè¿‡åˆ›å»ºé…ç½®æ–‡ä»¶å®ç° Babel é…ç½®ï¼ŒBabel 7.x ä¸­å­˜åœ¨ä¸¤ç§é…ç½®æ–‡ä»¶æ ¼å¼ï¼š

- `é¡¹ç›®èŒƒå›´é…ç½®`ï¼ˆProject-wide configurationï¼‰ï¼šä½¿ç”¨ `babel.config.json` æ–‡ä»¶ï¼Œæ”¯æŒ `.js`, `.cjs`, `.mjs` æ‰©å±•åã€‚åæ–‡ä¸­å°†ç§°å‘¼å…¶ä¸º**`babel.config.json`**ã€‚

- `ç›¸å¯¹æ–‡ä»¶é…ç½®`ï¼ˆFile-relative configurationï¼‰ï¼šä½¿ç”¨ `.babelrc.json` æ–‡ä»¶ï¼ˆ`.babelrc` æ˜¯ `.babelrc.json` çš„åˆ«åï¼‰ï¼ŒåŒæ ·æ”¯æŒä¸åŒçš„æ‰©å±•å `.js`, `.cjs`, `.mjs`ã€‚åæ–‡ä¸­å°†ç§°å‘¼å…¶ä¸º**`.babelrc.json`**ã€‚

è¿™ä¸¤ç§é…ç½®æ–‡ä»¶å¯ä»¥ä¸€èµ·ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥ç‹¬ç«‹ä½¿ç”¨ã€‚å¦‚æœä½ æƒ³å¯¹æŸæ–‡ä»¶æˆ–æŸç›®å½•çš„å­é›†ä¸Šè¿è¡ŒæŸäº›è½¬æ¢æ’ä»¶ï¼Œä½¿ç”¨ `.babelrc.json`ã€‚
å¦‚æœæ‚¨çš„é¡¹ç›®ä¸­æœ‰å¤šä¸ªåŒ…ï¼ˆå³å¤šä¸ª `package.json`ï¼‰ç›®å½•ä¸”éœ€è¦ç‹¬ç«‹çš„ Babel é…ç½®ï¼Œé‚£ä¹ˆåŠ å…¥ `babel.config.json` ä¼šå¾ˆæœ‰ç”¨ï¼Œè¿™ç§æƒ…å†µé€šå¸¸åœ¨ `monorepo` é¡¹ç›®ä¸­ï¼ˆä¸€ä¸ªé¡¹ç›®ä¸­å¤šä¸ªå­åŒ…ï¼Œä¸”å­åŒ…é—´å­˜åœ¨äº’ç›¸ä¾èµ–çš„ã€‚åæ–‡ä¸­æœ‰ä¸“é—¨é’ˆå¯¹æ­¤åœºæ™¯çš„ Babel ä½¿ç”¨ä»‹ç»ï¼‰ã€‚å¦‚æœåªæ˜¯å¸¸è§„é¡¹ç›®ï¼ˆä¸€ä¸ªé¡¹ç›®å³ä¸€ä¸ªåŒ…ï¼‰ï¼Œä½¿ç”¨ `.babelrc.json` å³å¯ã€‚

`babel.config.json` å¯¹æ•´ä¸ªé¡¹ç›®ç”Ÿæ•ˆï¼ŒåŒ…æ‹¬ `node_modules`ï¼Œ`babel.config.json` ä½œä¸ºé€šç”¨é…ç½®åœ¨å­åŒ…å…±äº«ï¼ŒåŒæ—¶æ¯ä¸ªå­åŒ…ä¹Ÿå¯ä»¥åšä¸ªæ€§é…ç½®é¡¹ã€‚

## é…ç½®é€‰é¡¹

è¿™é‡Œå…ˆä»‹ç»å¸¸è§„é¡¹ç›®ä¸­å¸¸ç”¨çš„é…ç½®é¡¹ï¼Œæ‰€æœ‰é…ç½®é€‰é¡¹æŸ¥çœ‹[è¿™é‡Œ](https://www.babeljs.cn/docs/options)ã€‚

``` json_
// .babelrc.json
{
  // æ’ä»¶åˆ—è¡¨ã€‚è¯¦è§ğŸ‘‡
  "plugins": [], 
   // é¢„è®¾åˆ—è¡¨ã€‚è¯¦è§ğŸ‘‡
  "presets": [],
}
```

**é…ç½®é¡¹è¯¦è§£ï¼š**

### `plugins`ï¼ˆæ’ä»¶ï¼‰

æ’ä»¶æ˜¯å°å‹çš„ JavaScript ç¨‹åºï¼Œç”¨äºå‘Šè¯‰ Babel å¦‚ä½•å¯¹ä»£ç è¿›è¡Œè½¬æ¢ã€‚

Babel çš„ä»£ç è½¬æ¢åŠŸèƒ½é€šè¿‡å°†æ’ä»¶ï¼ˆæˆ–é¢„è®¾ï¼‰åº”ç”¨åˆ°é…ç½®æ–‡ä»¶æ¥å¯åŠ¨ã€‚<br/>

Babel ç¼–è¯‘ä»£ç çš„è¿‡ç¨‹åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š
1. è§£æï¼ˆparseï¼‰ï¼šå°†ä»£ç å­—ç¬¦ä¸²è§£ææˆ ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰ï¼›
2. è½¬æ¢ï¼ˆtransformï¼šå¯¹ AST è¿›è¡Œè½¬æ¢ï¼Œè½¬æ¢åä¾ç„¶è¿˜æ˜¯ ASTï¼›
3. ç”Ÿæˆï¼ˆgenerateï¼‰ï¼šå°†è½¬æ¢åçš„ AST ç”Ÿæˆä»£ç å­—ç¬¦ä¸²ã€‚

è€Œæ’ä»¶åˆ†ä¸º `è¯­æ³•æ’ä»¶`ï¼ˆSyntax Pluginsï¼‰å’Œ `è½¬æ¢æ’ä»¶`ï¼ˆTransform Pluginsï¼‰ä¸¤ç§ã€‚å®˜æ–¹è¯­æ³•æ’ä»¶å’Œè½¬æ¢æ’ä»¶çš„åç§°åˆ†åˆ«ä»¥ `@babel/plugin-syntax`ã€`@babel/plugin-transform` å¼€å¤´ã€‚<br/>
è¯­æ³•æ’ä»¶åœ¨è§£æé˜¶æ®µä½œç”¨äºè§£æå™¨ï¼ˆ`@babel/parser`ï¼‰ï¼Œæ‰©å±•å…¶è¯­æ³•è§£æèƒ½åŠ›ï¼Œé€šè¿‡è½¬æ¢æ’ä»¶æ¥å®ç°ä»£ç è½¬æ¢ã€‚å¦‚æœå·²ç»é…ç½®ç›¸åº”çš„è½¬æ¢æ’ä»¶ï¼Œåˆ™ä¸éœ€è¦æŒ‡å®šè¯­æ³•æ’ä»¶ï¼Œå› ä¸ºä¼šè‡ªåŠ¨å¯ç”¨å®ƒï¼Œæ‰€ä»¥æåˆ° Babel æ’ä»¶é€šå¸¸æŒ‡çš„æ˜¯è½¬æ¢æ’ä»¶ã€‚

ä¾‹å¦‚æ·»åŠ  `@babel/plugin-transform-arrow-functions` æ’ä»¶åå¯è§£æå¹¶è½¬æ¢ç®­å¤´å‡½æ•°ï¼š

``` json_
{
  "plugins": [
    "@babel/plugin-transform-arrow-functions"
  ]
}
```
æºç ï¼š
``` js
var a = b => b;
```

è½¬æ¢åï¼š
``` js
var a = function (b) {
  return b;
};
```

### `presets`ï¼ˆé¢„è®¾ï¼‰

è¡¨ç¤ºä¸€ç»„æ’ä»¶çš„é›†åˆã€‚<br/>

å¦‚æœå¸Œæœ›ä½¿ç”¨ Babel å°† ES2015ï¼ˆES6ï¼‰ä»£ç ç¼–è¯‘æˆ ES5ï¼Œéœ€è¦é…ç½®[å¾ˆå¤šæ’ä»¶](https://babeljs.io/docs/en/plugins-list#es2015)ï¼Œä¸€ä¸ªä¸€ä¸ªæ’ä»¶è¿›è¡Œå®‰è£…é…ç½®ååˆ†ä¸ä¾¿ã€‚<br/>
å¦‚æœä½¿ç”¨Babel é¢„è®¾ `@babel/preset-es2015` åˆ™ç‰¹åˆ«ç®€å•ï¼Œå› ä¸ºå…¶åŒ…å«äº† ES2015 ç‰¹æ€§çš„æ‰€æœ‰æ’ä»¶ã€‚

``` bash
npm install @babel/preset-es2015 --save-dev 
```

``` json_
// .babelrc.json
{
  "plugins": [],
  "presets": [
    "@babel/preset-es2015"
  ],
  // æ­¤é€‰é¡¹å³å°†è¢«åºŸå¼ƒã€‚
  "env": {
    "development": {
      "presets": [["@babel/preset-react", { "development": true }]]
    }
  }
}
```

åœ¨ Babel 7 ä¸­ï¼Œæ‰€æœ‰ `Stage-x` é¢„è®¾ï¼ˆ`babel-preset-es2015` ã€`babel-preset-es2016` ~ `babel-preset-latest`ï¼‰éƒ½å·²ç»åºŸå¼ƒï¼Œä½¿ç”¨ `@babel/preset-env`ï¼ˆè¯¦è§ğŸ‘‡ï¼‰ æ›¿ä»£ã€‚

### æ’ä»¶é¡ºåºã€ä¼ é€’å‚æ•°

**æ’ä»¶é¡ºåº**

æ’ä»¶çš„æ’åˆ—é¡ºåºå¾ˆé‡è¦ï¼Œå¦‚æœä¸¤ä¸ªè½¬æ¢æ’ä»¶éƒ½å°†å¤„ç†æŸä¸€æ®µä»£ç å°†æ ¹æ®ä¸‹é¢è§„åˆ™æ‰§è¡Œï¼š

- æ’ä»¶åœ¨é¢„è®¾å‰è¿è¡Œï¼›
- æ’ä»¶é¡ºåºä»å‰å¾€åæ’åˆ—ï¼›
- é¢„è®¾é¡ºåºæ˜¯é¢ å€’çš„ï¼ˆä»åå¾€å‰ï¼‰ã€‚

``` json_
{
  "plugins": ["pluginA", "pluginB"],
  "presets": ["presetA", "presetB"]
}
```
æ‰§è¡Œé¡ºåºï¼špluginA => pluginB => presetB => presetA

**ä¼ é€’å‚æ•°**

æ’ä»¶å‚æ•°å’Œé¢„è®¾å‚æ•°çš„ä¼ é€’æ–¹å¼ä¸€æ ·ï¼Œå°† `æ’ä»¶å/é¢„è®¾å` å’Œ `å‚æ•°å¯¹è±¡` ç»„æˆä¸€ä¸ªæ•°ç»„åœ¨é…ç½®ä¸­è®¾ç½®ï¼š

``` json_
{
  "plugins": [
    "pluginA",
    ["pluginA", { "option1": value }] // ä¼ é€’å‚æ•°
  ],
  "presets": [
    "presetA",
    ["presetA", { "option1": value }]
  ]
}
```

## monorepos é¡¹ç›®

monorepos é¡¹ç›®ä¸­å­˜åœ¨å¤šä¸ªå­åŒ…ï¼Œ`babel.config.json` å’Œ `.babelrc.json` å¯ä»¥é…åˆä½¿ç”¨ã€‚ä¸‹é¢æ˜¯ monorepos åœºæ™¯ä¸€äº›å¸¸ç”¨åˆ°çš„é…ç½®é€‰é¡¹ï¼š

``` js
{
  // ç»§æ‰¿å…¶ä»–é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®ï¼Œå½“å‰é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®å­—æ®µå°†åˆå¹¶åˆ°æ‰©å±•æ–‡ä»¶çš„é…ç½®ä¹‹ä¸Šã€‚
  "extends": String,
  // æŒ‡å®šä»…é€‚ç”¨äºå­˜å‚¨åº“ä¸­æŸäº›å­ç›®å½•çš„é…ç½®
  "overrides": [],
  // åŒ¹é…ç›®å½•æˆ–æ–‡ä»¶ã€‚é€šå¸¸ä¸ overrides ä¸€èµ·ä½¿ç”¨
  "test": MatchPattern | Array<MatchPattern>,
  // babel é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåŠ è½½ä»»ä½•å­åŒ…ä¸­çš„ .babelrc.jsonï¼Œé™¤é babel.config.js ä¸­é…ç½®äº† babelrcRoots é€‰é¡¹ã€‚
  // ä¾‹å¦‚ ['.', './packages/*'] è¡¨ç¤ºå¯¹å½“å‰æ ¹ç›®å½•å’Œæ‰€æœ‰å­åŒ…å¼€å¯ .babelrc.json çš„åŠ è½½ï¼Œæ ¹ç›®å½•å¯åŒæ—¶å­˜åœ¨ babel.config.js å’Œ .babelrc.jsonã€‚
  "babelrcRoots": [],
}
```

ä¸‹é¢ğŸ‘‡é€‰é¡¹ä»…å…è®¸ä½œä¸º Babel ç¨‹åºé€‰é¡¹ä½¿ç”¨ã€‚ä¾‹å¦‚ `babel-loader` çš„ `options` é€‰é¡¹ä¸­ï¼ˆä¸‹é¢æœ‰ç¤ºä¾‹ï¼‰ã€å‘½ä»¤è¡Œé€‰é¡¹ä¸­ï¼ˆ`babel --rootMode=upward`ï¼‰ç­‰ï¼š

``` json_
{
  // â€œæ ¹â€ç›®å½•åˆå§‹è·¯å¾„ï¼Œé»˜è®¤ä¸º opts.cwd
  "root": string,
  // é¡¹ç›®æœ€ç»ˆ 'root' å€¼çš„ä¸åŒæ–¹å¼ï¼Œæœ‰ä¸‰ä¸ªé€‰é¡¹ï¼š
    // - 'root'ï¼šä¼ é€’ root å€¼ä¸å˜
    // - 'upward'ï¼šè‡ªåŠ¨å‘ä¸Šæ‰¾ babel.config.json åšä¸ºæ ¹ç›®å½•ä½ç½®ï¼Œæ²¡æ‰¾åˆ°å°±æŠ›é”™ï¼›
    // - upward-optionalï¼šç±»ä¼¼ upwardï¼Œæ²¡æ‰¾åˆ°å›é€€ã€‚
  "rootMode": string,
  // Babel é»˜è®¤åœ¨â€œæ ¹â€ç›®å½•è‡ªåŠ¨æœç´¢ babel.config.json ä½œä¸ºé¡¹ç›®èŒƒå›´é…ç½®ï¼Œæ­¤é€‰é¡¹å¯ä»¥æŒ‡å®š é¡¹ç›®èŒƒå›´é…ç½®æ–‡ä»¶ï¼Œä»è€Œè¦†ç›–é»˜è®¤çš„æœç´¢è¡Œä¸ºã€‚
  "configFile": string | boolean,
}
```

ç»“åˆä¸€ä¸ª monorepos é¡¹ç›®ï¼ˆå¦‚ä¸‹ç›®å½•ç»“æ„ï¼‰å¯¹ä¸Šé¢çš„é…ç½®é€‰é¡¹è¿›è¡Œä½¿ç”¨è¯´æ˜ï¼š

```
.
â”œâ”€â”€ packages
â”‚   â”œâ”€â”€ package-a 
â”‚   â”‚    â”œâ”€â”€ src
â”‚   â”‚    â”‚    â””â”€â”€ index.js
â”‚   â”‚    â”œâ”€â”€ .babelrc.json
â”‚   â”‚    â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ package-b
â”‚        â”œâ”€â”€ src
â”‚        â”‚    â””â”€â”€ index.js
â”‚        â”œâ”€â”€ .babelrc.json
â”‚        â””â”€â”€ package.json
â”‚
â”œâ”€â”€ babel.config.json
â””â”€â”€ package.json
```

Babel 7 ä¸­å¼•å…¥äº†ä¸€ä¸ª `root`ï¼ˆæ ¹ï¼‰çš„æ¦‚å¿µï¼Œé»˜è®¤ä¸ºå½“å‰å·¥ä½œç›®å½•ï¼ˆ`process.cwd()`ï¼‰ã€‚Babel å°†åœ¨æ­¤æ ¹ç›®å½•ä¸­è‡ªåŠ¨æœç´¢ `babel.config.json` æ–‡ä»¶ï¼ŒæŒ‡å®š `"configFile"` é€‰é¡¹å¯ä»¥æŒ‡å®šé¡¹ç›®èŒƒå›´é…ç½®æ–‡ä»¶ï¼Œä»è€Œè¦†ç›–æ­¤è¡Œä¸ºã€‚

é€šå¸¸å¯ä»¥å°†æ‰€æœ‰å­åŒ…çš„ Babel é…ç½®æ”¾åœ¨â€œæ ¹â€ç›®å½•çš„ `babel.config.json` ä¸­ï¼Œé€šè¿‡ `"overrides"` é€‰é¡¹å¯ä»¥å¯¹é¡¹ç›®ä¸­æŸäº›å­ç›®å½•æ–‡ä»¶è¿›è¡Œç‹¬ç«‹é…ç½®ã€‚
æ¯”å¦‚ä¸‹é¢ğŸ‘‡ `babel.config.json` ä¸­ `"@babel/preset-env"` é¢„è®¾æ˜¯å…±äº«çš„ï¼Œä½†å¯¹ `package-a` ä¸­çš„ JSX å…ƒç´ è¿›è¡Œäº† `automatic` æ¨¡å¼è½¬æ¢ï¼ˆå¼•å…¥äº† `react/jsx-runtime` æ¨¡å—ï¼‰ï¼Œå…¶ä»–åŒ…ä¸­çš„æ–‡ä»¶åˆ™ä½¿ç”¨ç»å…¸çš„ `classic` è½¬æ¢ï¼ˆå°† jsx è½¬æ¢ä¸º `React.createElement` è°ƒç”¨ï¼‰ã€‚

``` json_
// babel.config.json
{
  "presets": [
    "@babel/preset-env",
    ["@babel/preset-react", { "runtime": "classic" }]
  ],
  "overrides": [{
    "test": "./packages/package-a",
    "presets": [
      ["@babel/preset-react", { "runtime": "automatic" }]
    ]
  }]
}
```
*`@babel/preset-env` å’Œ `@babel/preset-react` çš„è¯¦ç»†ä½¿ç”¨å¯æŸ¥çœ‹[Babel å¸¸ç”¨æ’ä»¶ã€é¢„è®¾è¯¦è§£](https://github.com/wjcj/blog/issues/39)ã€‚*

å¦‚æœä½ æƒ³åœ¨ç‰¹å®šå­åŒ…ä¸­è¿è¡Œ Babelï¼ˆå½“å‰å·¥ä½œç›®å½•ä¸ Babel â€œæ ¹â€ç›®å½•ä¸ä¸€è‡´æ—¶ï¼‰ï¼Œä¸Šé¢çš„é…ç½®å°†ä¼šå‡ºç°é—®é¢˜ã€‚æ¯”å¦‚ä½  `cd ./packages/package-a` ç›®å½•ä¸‹åæ‰§è¡Œ `webpack` æ‰“åŒ…å°†æŠ¥é”™ã€‚

åœ¨ `babel-loader` é…ç½®é€‰é¡¹ä¸­æ·»åŠ  `rootMode: 'upward'` å°±å¯ä»¥æ¢å¤æ­£å¸¸ğŸ‘‡ï¼Œ`rootMode: 'upward'` è¡¨ç¤º Babel ä¼šè‡ªåŠ¨å‘ä¸Šæ‰¾ `babel.config.json` åšä¸ºâ€œæ ¹â€ç›®å½•ä½ç½®ï¼ˆå³`root` é€‰é¡¹çš„å€¼ï¼‰ã€‚

``` js
module.exports = {
  mode: 'development',
  module: {
    rules: [
      {
        test: /\.(js|jsx)$/,
        loader: require.resolve('babel-loader'),
        options: {
          rootMode: 'upward',
        }
      }
    ]
  }
};
```

Babel é»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåŠ è½½ä»»ä½•å­åŒ…ä¸­çš„ `.babelrc.json`ã€‚`babel.config.json` è®¾ç½® `babelrcRoots` åæ‰ä¼šå¯ç”¨ã€‚ä¸‹é¢é…ç½®è¡¨ç¤ºå¯ç”¨æ‰€æœ‰å­åŒ…çš„ `.babelrc.json` æ–‡ä»¶é…ç½®ã€‚
æ­¤é€‰é¡¹é€šå¸¸ç”¨äºæ›¿ä»£ `overrides` é€‰é¡¹æ¥å®ç°å­åŒ…çš„ä¸ªæ€§é…ç½®ã€‚

``` json_
{
  "babelrcRoots": ["./packages/*"]
}
```

Babel é…ç½®é€‰é¡¹éå¸¸å¤šï¼ŒæŸ¥çœ‹æ›´å¤šé€‰é¡¹è¯·æŸ¥çœ‹[å®˜ç½‘æ–‡æ¡£](https://babeljs.io/docs/en/options)ã€‚

## å‚è€ƒ

- [Babel](https://www.babeljs.cn/docs/)
- [Babel ç”¨æˆ·æ‰‹å†Œ](https://github.com/jamiebuilds/babel-handbook/blob/master/translations/zh-Hans/user-handbook.md#toc-babel-core)
